<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CNT Index Browser (Schmitz)</title>

<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
input { width:100%; font-size:16px; padding:10px; box-sizing:border-box; }
.row { padding:10px 6px; border-bottom:1px solid #ddd; }
.lemma { font-weight:700; }
.meta { color:#666; font-size:12px; margin-top:2px; }
.refs { margin-top:6px; font-family: ui-monospace, monospace; font-size:13px; white-space: normal; }
.chip {
  display:inline-block;
  padding:2px 6px;
  margin:2px 4px 2px 0;
  border:1px solid #bbb;
  border-radius:10px;
  text-decoration:none;
  color:inherit;
}
.chip:hover { background:#f2f2f2; }
.small { color:#666; font-size:12px; }
</style>

<h1>CNT Index Browser (Schmitz)</h1>
<p class="small">Dataset: 48 pages / 192 columns. Search is client-side.</p>

<input id="q" placeholder="Search lemma… (e.g. ab angelis, Aaron, Zeno)">
<div id="out"></div>

<script>
let INDEX = null;

function pad3(n){ return String(n).padStart(3,"0"); }

function tabFullHref(tab){
  const t = pad3(tab);
  return `tabs_full/${t}/Tab${t}.jpg`;
}

// Accept ref forms:
// - "1,17" or "001,017"
// - {tab:1, ent:17}
// - [1,17]
function parseRef(r){
  if (r == null) return null;

  if (typeof r === "string"){
    const m = r.trim().match(/^(\d+)\s*,\s*(\d+)$/);
    if (!m) return null;
    return {tab:Number(m[1]), ent:Number(m[2])};
  }
  if (Array.isArray(r) && r.length >= 2){
    const tab = Number(r[0]), ent = Number(r[1]);
    if (Number.isFinite(tab) && Number.isFinite(ent)) return {tab, ent};
    return null;
  }
  if (typeof r === "object"){
    const tab = Number(r.tab ?? r.TAB);
    const ent = Number(r.ent ?? r.ENT);
    if (Number.isFinite(tab) && Number.isFinite(ent)) return {tab, ent};
    return null;
  }
  return null;
}

function esc(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function renderRows(rows){
  const out = document.getElementById("out");
  out.innerHTML = rows.map(row => {
    const lemma = row.lemma ?? row.LEMMA ?? "";
    const lemma_key = row.lemma_key ?? row.LEMMA_KEY ?? "";
    const cnt_idx = row.cnt_idx ?? row.idx ?? row.index ?? "";

    const refs = row.refs ?? row.REFS ?? [];
    const refsHtml = refs.map(r => {
      const p = parseRef(r);
      if (!p) return "";
      const label = `${pad3(p.tab)},${pad3(p.ent)}`;
      const href = tabFullHref(p.tab);
      return `<a class="chip" href="${href}" target="_blank" rel="noopener">${label}</a>`;
    }).join("");

    return `<div class="row">
      <div class="lemma">${esc(lemma)}</div>
      <div class="meta">cnt_idx: ${esc(cnt_idx)}${lemma_key ? " · lemma_key: "+esc(lemma_key) : ""}</div>
      <div class="refs">${refsHtml}</div>
    </div>`;
  }).join("");
}

async function main(){
  const idxResp = await fetch("data_index.json");
  INDEX = await idxResp.json();

  // initial window
  renderRows(INDEX.slice(0,200));

  document.getElementById("q").addEventListener("input", (e) => {
    const q = e.target.value.trim().toLowerCase();
    if (!q) { renderRows(INDEX.slice(0,200)); return; }
    const hits = INDEX.filter(r => String(r.lemma ?? r.LEMMA ?? "").toLowerCase().includes(q)).slice(0,500);
    renderRows(hits);
  });
}

main();
</script>
